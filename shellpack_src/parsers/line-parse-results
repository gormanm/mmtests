#!/bin/bash
#
# Arg1: File pattern for logs as understood by grep -E
# Arg2: Name of the metric being matched
# Arg3: Position in line for measured value as understood by awk
SHELLPACK_ROOT=$(dirname $(realpath -s ${BASH_SOURCE[0]}))
SHELLPACK_BIN=$SHELLPACK_ROOT/../../bin/

LOGDIR=${1:-`pwd`}
cd $LOGDIR || exit 1

LPATTERN=$2
METRIC=$3
POS=$4

if [ "$LPATTERN" = "" -o "$METRIC" = "" -o "$POS" = "" ]; then
	echo "Usage: line-parse-results [log-directory] [line-pattern] [FactorA-pos] [FactorB-pos]"
	exit 127
fi

# Required output format, tab delimited
# - metric factorA factorB interval value extra
# Where;
# metric:	A primary metric like time, a specific operation e.g. Latency, Elapsed, transaction
# factorA:	Statistically relevant modifier such as percentile, thread count, worker etc
# factorB:	Secondary factor
# interval:	e.g. time elapsed, iteration etc
# value:	the benchmark measurement
# extra:	Optional value, currently used to identify a metric+factor for dashboard comparisons
ITERATION=0
for FACTORA in `\ls benchlog-* | cut -f2 -d- | sort -u`; do
	for FACTORB in `\ls benchlog-$FACTORA-* | cut -f3 -d- | sort -u`; do
		for LOG_NR in `\ls benchlog-$FACTORA-$FACTORB-* | cut -f4 -d- | sort -n`; do
			for VALUE in `cat benchlog-$FACTORA-$FACTORB-$LOG_NR | grep -E "$LPATTERN" | awk "{print \\$\$POS}"`; do
				((ITERATION++))
				echo -e "$METRIC\t$FACTORA\t$FACTORB\t$ITERATION\t$VALUE\t_"
			done
		done
	done
done
