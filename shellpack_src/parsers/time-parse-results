#!/bin/bash
SHELLPACK_ROOT=$(dirname $(realpath -s ${BASH_SOURCE[0]}))
SHELLPACK_BIN=$SHELLPACK_ROOT/../../bin/
if [ ! -e $SHELLPACK_BIN ]; then
	SHELLPACK_BIN=$SHELLPACK_ROOT/../bin/
fi

LOGDIR=${1:-`pwd`}
cd $LOGDIR || exit 1

# Required output format, tab delimited
# - metric factorA factorB interval value extra
# Where;
# metric:	A primary metric like time, a specific operation e.g. Latency, Elapsed, transaction
# factorA:	Statistically relevant modifier such as percentile, thread count, worker etc
# factorB:	Secondary factor
# interval:	e.g. time elapsed, iteration etc
# value:	the benchmark measurement
# extra:	Optional value, currently used to identify a metric+factor for dashboard comparisons
for FACTORA in `ls time-*-1 | awk -F - '{print $2}'`; do
	for ITERATION in `\ls time-$FACTORA-* | cut -f3 -d- | sort -n`; do
		ENTRY=`cat time-$FACTORA-$ITERATION | $SHELLPACK_BIN/extract-time`
		USER=`echo $ENTRY | cut -d' ' -f1`
		SYST=`echo $ENTRY | cut -d' ' -f2`
		ELSP=`echo $ENTRY | cut -d' ' -f3`
		[ "$PARSE_EXCLUDE_USER_TIME" != "yes" ] && echo -e "User\t$FACTORA\t_\t$ITERATION\t$USER\t_"
		[ "$PARSE_EXCLUDE_SYST_TIME" != "yes" ] && echo -e "System\t$FACTORA\t_\t$ITERATION\t$SYST\t_"
		[ "$PARSE_EXCLUDE_ELSP_TIME" != "yes" ] && echo -e "Elapsed\t$FACTORA\t_\t$ITERATION\t$ELSP\t_"
	done
done | sort -k1,1 -k2,2n -k4,4n
