#!/bin/bash
SHELLPACK_ROOT=$(dirname $(realpath -s ${BASH_SOURCE[0]}))

LOGDIR=${1:-`pwd`}
cd $LOGDIR || exit 1

# Required output format, tab delimited
# - metric factorA factorB interval value extra
# Where;
# metric:	A primary metric like time, a specific operation e.g. Latency, Elapsed, transaction
# factorA:	Statistically relevant modifier such as percentile, thread count, worker etc
# factorB:	Secondary factor
# interval:	e.g. time elapsed, iteration etc
# value:	the benchmark measurement
# extra:	Optional value, currently used to identify a metric+factor for dashboard comparisons
for NR_THREADS in `\ls fsmark-*.log.gz | sed -e 's/\.log.gz$//' | cut -d- -f2 | sort -n`; do
	NR_CONTEXT=`zcat fsmark-$NR_THREADS.log.gz | wc -l`
	ITERATION=0
	for VALUE in `zgrep -A $NR_CONTEXT "App Overhead" fsmark-$NR_THREADS.log.gz | grep -v "App Overhead" | awk '{print $4}'`; do
		((ITERATION++))
		echo -e "files_sec\t$NR_THREADS\t_\t$ITERATION\t$VALUE\t_"
	done
done | sort -k1,1 -k4,4n
