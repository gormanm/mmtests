#!/bin/bash
###SHELLPACK preamble sqlite-bench 3340000

###SHELLPACK parseargBegin
###SHELLPACK parseargInstall
###SHELLPACK parseargParam    --size         SQLITE_SIZE
###SHELLPACK parseargParam    --iterations   SQLITE_ITERATIONS
###SHELLPACK parseargEnd
###SHELLPACK monitor_hooks

###SHELLPACK init_only_start
install-depends util-linux
###SHELLPACK check_install_required sqlite-${VERSION}
###SHELLPACK init_only_end

echo Creating insert script for $SQLITE_SIZE entries
cat /dev/urandom | base64 -w 20 | head -$SQLITE_SIZE | sed "s/\(.\{4\}\)\(.\{16\}\)/INSERT INTO 'mmtests' ('SmallInt', 'DateTime', 'ShortString', 'LongString') VALUES ('10', CURRENT_TIMESTAMP, '\1', '\2');/" > $SHELLPACK_TEMP/basic-insert.script

###SHELLPACK iteration_begin $SQLITE_ITERATIONS
echo Creating table iteration $ITERATION/$SQLITE_ITERATIONS
cd $SHELLPACK_SOURCES/sqlite-${VERSION}-installed || die "Failed to cd to sqlite install directory"
rm -f $SHELLPACK_DATA/benchmark-$ITERATION.db
./bin/sqlite3 $SHELLPACK_DATA/benchmark-$ITERATION.db "CREATE TABLE mmtests
	('SmallInt'    SMALLINT NOT NULL,
	 'DateTime'    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	 'ShortString' VARCHAR(4) NOT NULL,
	 'LongString'  VARCHAR(16) NOT NULL
	);" || die "Failed to create table"

echo Inserting $SQLITE_SIZE rows iterations $ITERATION/$SQLITE_ITERATIONS
mmtests_activity sqlite-insert
monitor_pre_hook $LOGDIR_RESULTS $P-$ITERATION
$TIME_CMD -o $LOGDIR_RESULTS/time-_-$ITERATION									\
	./bin/sqlite-txnpersec.pl $SHELLPACK_DATA/benchmark-$ITERATION.db $SHELLPACK_TEMP/basic-insert.script	\
		&> $LOGDIR_RESULTS/benchlog-_-_-$ITERATION || die "Failed to execute sqlite basic-insert.script"
monitor_post_hook $LOGDIR_RESULTS $P-$ITERATION
###SHELLPACK iteration_end $SQLITE_ITERATIONS

mv $SHELLPACK_TEMP/basic-insert.script $LOGDIR_RESULTS/
xz $LOGDIR_RESULTS/basic-insert.script
exit $SHELLPACK_SUCCESS
