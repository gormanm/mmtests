#!/bin/bash
###SHELLPACK preamble poundsyscall-bench 0

ITERATIONS=30

###SHELLPACK parseargBegin
###SHELLPACK parseargInstall
###SHELLPACK parseargParam	--min-threads	POUNDSYSCALL_MIN_THREADS
###SHELLPACK parseargParam	--max-threads	POUNDSYSCALL_MAX_THREADS
###SHELLPACK parseargParam	--iterations	POUNDSYSCALL_ITERATIONS
###SHELLPACK parseargEnd
###SHELLPACK monitor_hooks

###SHELLPACK check_install_required poundsyscall-${VERSION}

TESTBIN="pound_getppid"

###SHELLPACK threads_powertwo_begin $POUNDSYSCALL_MIN_THREADS $POUNDSYSCALL_MAX_THREADS
	for FILE in ${TESTBIN}; do
		gcc -O2 -lpthread -DNUM_THREADS=$NR_THREADS \
				$SHELLPACK_SOURCES/poundsyscall-${VERSION}-installed/${TESTBIN}.c \
				-o $SHELLPACK_TEMP/${TESTBIN} || \
			die "Failed to build ${TESTBIN}.c thread count $NR_THREADS"
	done

	for FILE in ${TESTBIN}; do
		monitor_pre_hook $LOGDIR_RESULTS ${TESTBIN}-$NR_THREADS
		###SHELLPACK iteration_begin $POUNDSYSCALL_ITERATIONS
			echo Starting ${TESTBIN} $NR_THREADS/$POUNDSYSCALL_MAX_THREADS iteration $ITERATION/$POUNDSYSCALL_ITERATIONS
				$TIME_CMD -o $LOGDIR_RESULTS/time-${NR_THREADS}-${ITERATION} \
					$SHELLPACK_TEMP/${TESTBIN} &>/dev/null
		###SHELLPACK iteration_end $POUNDSYSCALL_ITERATIONS
		monitor_post_hook $LOGDIR_RESULTS ${TESTBIN}-$NR_THREADS
	done
###SHELLPACK threads_powertwo_end
exit $SHELLPACK_SUCCESS
