#!/bin/bash
SHELLPACK_ROOT=$(dirname $(realpath -s ${BASH_SOURCE[0]}))

LOGDIR=${1:-`pwd`}
cd $LOGDIR || exit 1

# Required output format, tab delimited
# - metric factorA factorB interval value extra
# Where;
# metric:	A primary metric like time, a specific operation e.g. Latency, Elapsed, transaction
# factorA:	Statistically relevant modifier such as percentile, thread count, worker etc
# factorB:	Secondary factor
# interval:	e.g. time elapsed, iteration etc
# value:	the benchmark measurement
# extra:	Optional value, currently used to identify a metric+factor for dashboard comparisons
for WORKERS in `\ls ebizzy-*.log | sed -e 's/\.log$//' | cut -d- -f2 | sort -u -n`; do
	NR_SAMPLE=0
	for ITERATION in `\ls ebizzy-*.log | sed -e 's/\.log$//' | cut -d- -f3 | sort -u -n`; do
		LINE=`head -1 ebizzy-$WORKERS-$ITERATION.log`
		TOTAL=`echo $LINE | awk '{print $1}'`
		PERTHREAD_LIST=`echo $LINE | sed -e 's/.* records\/s //'`
		PERTHREAD_LIST=`head -1 ebizzy-$WORKERS-$ITERATION.log | sed -e 's/.* records\/s //'`

		echo -e "total_rec\t$WORKERS\t_\t$ITERATION\t$TOTAL\t_"
		for THREAD_VAL in $PERTHREAD_LIST; do
			((NR_SAMPLE++))
			echo -e "thread_rec\t$WORKERS\t_\t$NR_SAMPLE\t$THREAD_VAL\t_"
		done
	done
done | sort -k1,1 -k2,2n -k4,4n
