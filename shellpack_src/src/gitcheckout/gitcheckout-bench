#!/bin/bash
# This benchmark checks how long it takes to do cache cold or hot checkouts
# between two kernel versions. It is somewhat metadata intensive
#
# Copyright Mel Gorman 2013
###SHELLPACK preamble gitcheckout-bench v6.18

GITCHECKOUT_CACHE=hot
GITCHECKOUT_ITERATIONS=15

###SHELLPACK parseargBegin
###SHELLPACK parseargParam --commits	GITCHECKOUT_COMMITS
###SHELLPACK parseargParam --iterations GITCHECKOUT_ITERATIONS
###SHELLPACK parseargParam --cache      GITCHECKOUT_CACHE
###SHELLPACK parseargEnd
###SHELLPACK monitor_hooks

install-depends git-core

# Get the git repository
###SHELLPACK init_only_start
###SHELLPACK check_install_required_continue gitcheckout-${VERSION}
	# Setup source
	cd $SHELLPACK_DATA || die "Failed to change to $SHELLPACK_DATA"
        rm -rf gitcheckout-$VERSION
	tar -xf $SHELLPACK_SOURCES/gitcheckout-$VERSION.tar.xz || die "Failed to extract $SHELLPACK_SOURCES/gitcheckout-$VERSION.tar.xz"
###SHELLPACK init_only_end

GITCHECKOUT_COMMITS=`echo $GITCHECKOUT_COMMITS | sed -e 's/,/ /g'`
cd $SHELLPACK_DATA/gitcheckout-$VERSION-installed || die "Unexpected directory layout for source, no $SHELLPACK_DATA/gitcheckout-$VERSION-installed"

if [ "$GITCHECKOUT_CACHE" = "cold" ]; then
	sysctl -w vm.drop_caches=3
fi

echo Creating test script to checkout $GITCHECKOUT_COMMITS
cat > $SHELLPACK_TEMP/gitcheckout.sh << EOF
#!/bin/bash
echo Workdir: $SHELLPACK_DATA/gitcheckout-$VERSION-installed
cd $SHELLPACK_DATA/gitcheckout-$VERSION-installed
for COMMIT in $GITCHECKOUT_COMMITS; do
	echo Checkout: \$COMMIT
	git checkout \$COMMIT || exit 127
done
EOF

chmod u+x $SHELLPACK_TEMP/gitcheckout.sh

echo Warming up
mmtests_activity warmup
$SHELLPACK_TEMP/gitcheckout.sh || die "Failed to warmup"

###SHELLPACK iteration_begin $GITCHECKOUT_ITERATIONS
	monitor_pre_hook $LOGDIR_RESULTS $ITERATION
	if [ "$GITCHECKOUT_CACHE" = "cold" ]; then
		echo Dropping caches as per requested
		sync
		sysctl -w vm.drop_caches=3
	fi

	echo Iteration $ITERATION/$GITCHECKOUT_ITERATIONS
	$TIME_CMD -o $LOGDIR_RESULTS/gitcheckout-$ITERATION.time $SHELLPACK_TEMP/gitcheckout.sh &>gitcheckout-last.log
	if [ $? -ne 0 ]; then
		echo Dumping output
		cat $LOGDIR_RESULTS/gitcheckout-last.log
		die "Failed to execute git checkout"
	fi
	monitor_post_hook $LOGDIR_RESULTS $ITERATION
###SHELLPACK iteration_end

# Cleanup
rm $LOGDIR_RESULTS/gitcheckout-last.log
cd /
rm -rf $SHELLPACK_DATA/gitcheckout-$VERSION*

exit $SHELLPACK_SUCCESS
